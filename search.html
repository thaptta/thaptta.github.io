<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>K·∫øt qu·∫£ t√¨m ki·∫øm</title>
  <link rel="stylesheet" href="Styles/1.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">
        <div class="mark">TH</div>
        <h1>Tr∆∞·ªùng Ti·ªÉu h·ªçc A Phong Th·∫°nh T√¢y A</h1>
      </div>
      <div class="search-area">
        <input id="search-box" placeholder="üîé T√¨m..." onkeypress="handleSearch(event)">
      </div>
      <div id="user-info" class="user-actions"></div>
    </div>

    <main class="card">
      <h2>K·∫øt qu·∫£ t√¨m ki·∫øm</h2>
      <div id="results"></div>
    </main>
  </div>

  <script type="module">
    import { db } from './Scripts/firebase.js';
    import { collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const keyword = localStorage.getItem("searchKeyword")?.toLowerCase() || "";
    const resultsDiv = document.getElementById("results");

    async function searchPosts() {
      const snap = await getDocs(collection(db, "posts"));
      let found = 0;

      snap.forEach(docSnap => {
        const d = docSnap.data();
        const title = (d.title || "").toLowerCase();
        const content = (d.content || "").toLowerCase();

        if (title.includes(keyword) || content.includes(keyword)) {
          found++;
          const el = document.createElement("div");
          el.className = "post-preview";
          el.innerHTML = `
            ${d.imageURL ? `<img src="${d.imageURL}" alt="·∫¢nh minh h·ªça" style="width:100%;max-height:200px;object-fit:cover;border-radius:8px;margin-bottom:8px;">` : ""}
            <h3>${d.title}</h3>
            <p class="meta">${d.category || ''} ‚Ä¢ ${d.createdAt ? new Date(d.createdAt.toDate()).toLocaleDateString() : ''}</p>
            <p>${(d.content || '').slice(0, 140)}...</p>
            <div class="actions">
              <button class="btn" onclick="openPost('${docSnap.id}')">Xem</button>
            </div>
          `;
          resultsDiv.appendChild(el);
        }
      });

      if (found === 0) {
        resultsDiv.innerHTML = "<p>Kh√¥ng t√¨m th·∫•y b√†i vi·∫øt ph√π h·ª£p.</p>";
      }
    }

    // ‚úÖ X·ª≠ l√Ω n·∫øu kh√¥ng c√≥ keyword
    if (!keyword) {
      resultsDiv.innerHTML = "<p>Vui l√≤ng nh·∫≠p t·ª´ kh√≥a ƒë·ªÉ t√¨m ki·∫øm.</p>";
    } else {
      searchPosts();
    }

    // üëâ M·ªü b√†i vi·∫øt chi ti·∫øt
    window.openPost = function(id) {
      localStorage.setItem('postId', id);
      window.location.href = 'kqtk.html'; // ƒë·ªïi ƒë√∫ng t√™n file chi ti·∫øt
    };

    // üîç T√¨m l·∫°i b√†i m·ªõi
    window.handleSearch = (e) => {
      if (e.key === 'Enter') {
        const k = document.getElementById('search-box').value.trim().toLowerCase();
        if (k) {
          localStorage.setItem('searchKeyword', k);
          window.location.href = 'search.html';
        }
      }
    };
  </script>
</body>
</html>
