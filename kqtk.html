<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>Chi ti·∫øt b√†i vi·∫øt</title>
  <link rel="stylesheet" href="Styles/1.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">
        <div class="mark">TH</div>
        <h1>Tr∆∞·ªùng Ti·ªÉu h·ªçc A Phong Th·∫°nh T√¢y A</h1>
      </div>
      <div class="search-area">
        <input id="search-box" placeholder="üîé T√¨m..." onkeypress="handleSearch(event)">
      </div>
      <div id="user-info" class="user-actions"></div>
    </div>

    <main class="card">
      <div id="post-detail">
        <h2 class="detail-title" id="post-title"></h2>
        <p class="meta" id="post-meta"></p>
        <div id="post-content"></div>
        <div id="delete-btn-container"></div>
      </div>
    </main>
  </div>

  <script type="module">
  import { db, auth } from './Scripts/firebase.js';
  import { doc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

  const id = localStorage.getItem("postId");

  async function load() {
    if (!id) {
      document.getElementById('post-title').textContent = "Kh√¥ng t√¨m th·∫•y b√†i vi·∫øt.";
      return;
    }

    const snap = await getDoc(doc(db, "posts", id));
    if (!snap.exists()) {
      document.getElementById('post-title').textContent = "B√†i vi·∫øt kh√¥ng t·ªìn t·∫°i.";
      return;
    }

    const d = snap.data();
    document.getElementById('post-title').textContent = d.title;
    document.getElementById('post-meta').textContent =
      `${d.category || ''} ‚Ä¢ ${d.createdAt ? new Date(d.createdAt.toDate()).toLocaleString() : ''} ‚Ä¢ T√°c gi·∫£: ${d.author || ''}`;
    document.getElementById('post-content').innerHTML =
      `<div style="white-space: pre-wrap; margin-top: 12px;">${d.content}</div>`;

    // üü¢ Ki·ªÉm tra n·∫øu ng∆∞·ªùi ƒëƒÉng nh·∫≠p l√† t√°c gi·∫£ th√¨ hi·ªán n√∫t xo√°
    onAuthStateChanged(auth, user => {
      if (user && user.email === d.author) {
        document.getElementById("delete-btn-container").innerHTML = `
          <button class="btn ghost" onclick="deletePost('${id}')">üóëÔ∏è X√≥a b√†i vi·∫øt</button>
        `;
      }
    });
  }

  // üöÆ H√†m xo√° b√†i vi·∫øt
  window.deletePost = async function(id) {
    if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b√†i vi·∫øt n√†y kh√¥ng?")) return;
    try {
      await deleteDoc(doc(db, "posts", id));
      alert("‚úÖ ƒê√£ x√≥a b√†i vi·∫øt th√†nh c√¥ng!");
      window.location.href = "index.html";
    } catch (err) {
      alert("‚ùå L·ªói khi x√≥a b√†i: " + err.message);
    }
  };

  load();

  // üîç T√¨m ki·∫øm l·∫°i b√†i
  window.handleSearch = (e) => {
    if (e.key === 'Enter') {
      const k = document.getElementById('search-box').value.trim().toLowerCase();
      if (k) {
        localStorage.setItem('searchKeyword', k);
        window.location.href = 'search.html';
      }
    }
  };
</script>

</body>
</html>
